
    const cartModal = $("#cart-modal");
    const cartMenu = $("#cart-menu");
    const totalQuantityLabel = $("#total-quantity-label");
    const modalItemNameLabel = $("#item-name");
    const modalItemPriceLabel = $("#item-price");
    const modalItemQuantityInput = $("#quantity");
    const modalItemTotalLabel = $("#item-total");
    const checkoutTotalLabel = $("#checkoutTotalLabel");

    function addToCart(itemHTMLElement) {
        const itemElement = $(itemHTMLElement);
        const price = parseInt(itemElement.data("price"));
        const name = itemElement.data("name");
        const itemId = itemElement.data("id");

        modalItemNameLabel.data("elementId", itemHTMLElement.id);
        modalItemNameLabel.html(name);
        modalItemPriceLabel.html(`Unit Price: ${price}`);

        function onQuantityChanged() {
            let quantity = parseInt(this.value);
            if (isNaN(quantity)) {
                quantity = 0;
            }
            modalItemTotalLabel.html(`Total: : ${quantity * price}`);
        }

        modalItemQuantityInput.on("keyup", onQuantityChanged);
        modalItemQuantityInput.on("change", onQuantityChanged);

        setInitialQuantityAndTotalPrice(itemId, price);
        cartModal.modal("show");
    }

    function setInitialQuantityAndTotalPrice(itemId) {
        const cart = getCart();
        const i = indexOfItemInCart(cart, itemId);
        if (i >= 0) {
            modalItemQuantityInput.val(cart[i].quantity + 1);
        } else {
            modalItemQuantityInput.val(1);
        }
        modalItemQuantityInput.trigger("change");
    }

    function indexOfItemInCart(cart, itemId) {
        for (const i in cart) {
            const cartItem = cart[i];

            if (cartItem.itemId === itemId) {
                return i;
            }
        }

        return -1;
    }

    function updateOrAddToCart(cart, item) {
        var i = indexOfItemInCart(cart, item.itemId);
        if (i >= 0) {
            cart[i].quantity = item.quantity;
        } else {
            cart.push(item);
        }

    }

    function getCart() {
        return JSON.parse(localStorage.getItem("cart")) || [];
    }

    $("#save").on("click", function () {
        const elementId = modalItemNameLabel.data("elementId");
        const itemElement = $(`#${elementId}`);

        const price = parseInt(itemElement.data("price"));
        const name = itemElement.data("name");
        const quantity = parseInt(modalItemQuantityInput.val());
        const itemId = itemElement.data("id");

        const item = { itemId, name, quantity, price };
        const cart = getCart();
        updateOrAddToCart(cart, item);
        updateCart(cart);
        updateCartMenu();
        cartModal.modal("toggle");
    });

    function updateCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
    }

    function updateCartMenu() {
        const cart = getCart();
        let elements = "";
        let totalPrice = 0;
        cart.forEach((item) => {
            itemTotalPrice = item.quantity * item.price;
            totalPrice += itemTotalPrice;
           
            elements += `<small><strong>${item.name}</strong>   [${item.quantity}]  [N${itemTotalPrice}] <button class="btn btn-sm btn-danger " onclick="deleteItemFromCart(${item.itemId}, getCart())"><span class="fa fa-cut" aria-hidden="true"></span></button></small>`;
            
            elements += `<hr>`;
        });
        
        elements += `<strong class="float-right text-success font-weight-bolder">Total Price: N${totalPrice}</strong>`;
        elements += `<hr>`;
        elements += `<button class="btn btn-sm btn-danger " onclick="clearCart(getCart())">Empty Cart</button>`;
        elements += `<hr>`;
        cartMenu.html(elements);
        var totalQuantity = getTotalQuantity();
        totalQuantityLabel.html(totalQuantity);
        newTotalQuantityLabel.html(totalQuantity);
        checkoutTotalLabel.html(totalPrice);
    }
    

    function getTotalQuantity() {
        const cart = getCart();
        let sum = 0;
        cart.forEach((item) => {
            sum += item.quantity;
        });
        return sum;
    }

    function clearCart() {
        const cart = [];
        updateCart(cart);
        updateCartMenu();
    }

    function deleteItemFromCart(itemId, cart) {
        const i = indexOfItemInCart(cart, itemId);
        if (i > -1) {
            cart.splice(i, 1);
        }
        updateCart(cart);
        updateCartMenu();
    }

    $(document).ready(function () {
        updateCartMenu();
        $('[data-toggle="popover"]').popover();
    });

